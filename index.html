<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View & Edit Packages</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #eef2f7;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .container {
    background: #fff;
    padding: 30px 25px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 950px;
    text-align: center;
  }

  h2 {
    font-size: 1.8rem;
    color: #333;
    margin-bottom: 20px;
  }

  label {
    font-weight: bold;
  }

  input[type="text"] {
    padding: 6px;
    width: 200px;
    margin-right: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  button {
    padding: 8px 16px;
    background: #4CAF50;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background: #45a049;
  }

  #message {
    margin-top: 15px;
    font-weight: bold;
    white-space: pre-line;
    color: green;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }

  th {
    background: #f4f4f4;
  }

  input.table-edit {
    width: 100%;
    box-sizing: border-box;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  @media (max-width: 768px) {
    input[type="text"] {
      width: 140px;
      margin-bottom: 10px;
    }

    table, th, td {
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h2>View & Edit Packages</h2>

  <label for="sellerInput">Enter Seller ID:</label>
  <input type="text" id="sellerInput" placeholder="e.g. S123">
  <button onclick="searchSeller()">Search</button>

  <div id="message"></div>

  <table id="packagesTable" style="display:none;">
    <thead>
      <tr>
        <th>PackageID</th>
        <th>Package Name</th>
        <th>Duration (hrs)</th>
        <th>Price (KES)</th>
        <th>Router Profile</th>
        <th>Status</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const WORKER_URL = "https://long-rice-8526.dmaundu02.workers.dev/";

  async function fetchFromWorker(action, payload) {
    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, ...payload })
      });
      return await res.json();
    } catch (err) {
      return { success: false, message: err.message };
    }
  }

  const table = document.getElementById('packagesTable');
  const tbody = table.querySelector('tbody');
  const messageDiv = document.getElementById('message');

  async function searchSeller() {
    const sellerId = document.getElementById('sellerInput').value.trim();
    if (!sellerId) {
      messageDiv.textContent = "‚ö†Ô∏è Please enter a Seller ID.";
      messageDiv.style.color = "red";
      table.style.display = 'none';
      return;
    }

    messageDiv.textContent = "‚è≥ Checking seller...";
    messageDiv.style.color = "green";
    messageDiv.style.fontWeight = "bold";

    const res = await fetchFromWorker("getSellerById", { sellerId });
    if (!res || !res.found) {
      messageDiv.textContent = "‚ùå Seller not found.";
      messageDiv.style.color = "red";
      table.style.display = 'none';
      return;
    }

    messageDiv.innerHTML = "üëã <span style='color:green; font-weight:bold;'>" + res.name + " (" + res.id + ")</span>";
    loadPackages(sellerId);
  }

  async function loadPackages(sellerId) {
    messageDiv.textContent += "\n‚è≥ Loading packages...";
    const packages = await fetchFromWorker("getPackagesBySeller", { sellerId });
    tbody.innerHTML = '';

    if (!packages || packages.length === 0) {
      messageDiv.textContent = "No packages found for this seller.";
      messageDiv.style.color = "orange";
      table.style.display = 'none';
      return;
    }

    packages.forEach(p => {
      const tr = document.createElement('tr');

      // PackageID (readonly)
      const tdId = document.createElement('td');
      tdId.textContent = p.PackageID;
      tr.appendChild(tdId);

      // Editable fields
      ['PackageName','DurationHrs','PriceKES','RouterProfile','Status'].forEach(field => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.classList.add("table-edit");
        input.value = p[field];
        input.addEventListener('change', async function() {
          messageDiv.textContent = "‚è≥ Updating...";
          messageDiv.style.color = "green";
          messageDiv.style.fontWeight = "bold";

          const updateRes = await fetchFromWorker("updatePackage", { packageId: p.PackageID, field, value: input.value });
          messageDiv.textContent = updateRes.success ? "‚úÖ Updated" : "‚ùå " + updateRes.message;
          messageDiv.style.color = updateRes.success ? "green" : "red";
          messageDiv.style.fontWeight = "bold";
        });
        td.appendChild(input);
        tr.appendChild(td);
      });

      // CreatedAt (readonly)
      const tdCreated = document.createElement('td');
      tdCreated.textContent = p.CreatedAt;
      tr.appendChild(tdCreated);

      tbody.appendChild(tr);
    });

    table.style.display = 'table';
    messageDiv.textContent = "‚úÖ Packages loaded for seller.";
    messageDiv.style.color = "green";
    messageDiv.style.fontWeight = "bold";
  }
</script>
</body>
</html>
